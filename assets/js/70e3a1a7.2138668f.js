"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([[428],{6913:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var s=t(8610),a=t(4848),i=t(8453);const r={slug:"troubleshooting-in-redshift",title:"Troubleshooting in Redshift",authors:["narendra"],tags:["big-data","redshift","aws","database"],date:new Date("2019-04-15T00:00:00.000Z")},o="Troubleshooting in Redshift",l={authorsImageUrls:[void 0]},d=[{value:"Table Overview",id:"table-overview",level:2},{value:"Important Queries",id:"important-queries",level:2},{value:"Queries waiting in queue",id:"queries-waiting-in-queue",level:3},{value:"Long Running Queries",id:"long-running-queries",level:3},{value:"Blocking Queries",id:"blocking-queries",level:3},{value:"DeadLocked",id:"deadlocked",level:3},{value:"How to cancel a query?",id:"how-to-cancel-a-query",level:2},{value:"Bonus",id:"bonus",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"Redshift is a one of the most popular data warehousing solution, thousands of companies running millions of ETL jobs everyday. The problem with MPP systems is troubleshooting why the jobs are hung, which are the queries blocking others."}),"\n",(0,a.jsx)(n.p,{children:"To troubleshoot problems like this could be a real nightmare if you are new to Redshift, in this article I have tried to aggregate the tables and queries you should always keep handy if you work with redshift on daily basis of planning to start using"}),"\n",(0,a.jsx)(n.h2,{id:"table-overview",children:"Table Overview"}),"\n",(0,a.jsx)(n.p,{children:"First of all lets familiarize our self  with some of the tables needed to troubleshoot a problem."}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/redshift/latest/dg/r_STV_RECENTS.html",children:"STV_RECENTS"})})," - This table holds information about currently active and recently run queries against a database"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select \n\tuser_name, \n\tdb_name, \n\tpid, \n\tquery\nfrom stv_recents\nwhere status = 'Running';\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"status = 'Running'"})," gives all the queries whose execution have not completed. it includes the queries which are currently executing and the queries currently waiting in the execution queue."]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/redshift/latest/dg/r_STV_INFLIGHT.html",children:"STV_INFLIGHT"})})," - Check the ",(0,a.jsx)(n.code,{children:"stv_inflight"})," table, To find which queries are currently in progress."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select \n\tuserid, \n\tquery, \n\tpid, \n\tstarttime, \n\tleft(text, 50) as text \nfrom stv_inflight;\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/redshift/latest/dg/r_STV_LOCKS.html",children:"STV_LOCKS"})})," - Amazon Redshift locks tables to prevent two users from updating the same table at the same time, STV_LOCKS can be used to view any current updates on tables in the database, need superuser to view"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select \n\ttable_id, \n\tlast_update, \n\tlast_commit, \n\tlock_owner, \n\tlock_owner_pid, \n\tlock_status from stv_locks  \norder by last_update asc;\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/redshift/latest/dg/r_STL_TR_CONFLICT.html",children:"STL_TR_CONFLICT"})})," - A transaction conflict occurs when two or more users are querying and modifying data rows from tables such that their transactions cannot be serialized. Every time a transaction conflict occurs, Amazon Redshift writes a log about the aborted transaction to the STL_TR_CONFLICT table."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select * from stl_tr_conflict \nwhere table_id=<Table Id from STV_LOCKS>\norder by xact_start_ts;\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/redshift/latest/dg/r_SVV_TRANSACTIONS.html",children:"SVV_TRANSACTIONS"})})," - Redshift uses this table to records information about transactions that currently hold locks on tables in the database"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select * from svv_transactions;\n"})}),"\n",(0,a.jsx)(n.h2,{id:"important-queries",children:"Important Queries"}),"\n",(0,a.jsx)(n.h3,{id:"queries-waiting-in-queue",children:"Queries waiting in queue"}),"\n",(0,a.jsx)(n.p,{children:"If the query is running for more then expected the first thing you would like to do is figure out if the query actually executing or laying in the queue waiting for its turn."}),"\n",(0,a.jsx)(n.p,{children:'To find out queries that are not truly "in flight" i.e waiting in the queue of blocked by some other query'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select * from stv_recents \nwhere status<>'Done' and pid not in (select pid from stv_inflight)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"long-running-queries",children:"Long Running Queries"}),"\n",(0,a.jsx)(n.p,{children:"In case you are curious to know who else is delayed or running for long time, this query can help you find out list of all the queries running longer then 30 mints."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select \n\tpid, \n\ttrim(user_name) AS user_name, \n\tstarttime, \n\tquery, \n\tDATEDIFF(minutes, starttime, getdate()) as delay_in_mints, \n\tstatus\nfrom stv_recents \nwhere \n\tstatus='Running' and  \n\tDATEDIFF(minutes, starttime, getdate()) > 30\norder by starttime;\n"})}),"\n",(0,a.jsx)(n.h3,{id:"blocking-queries",children:"Blocking Queries"}),"\n",(0,a.jsx)(n.p,{children:"To find out the cause you must verify the locks this query can be used to find out what are the queries which have been granted the lock for the resources and what are the queries blocked by it or waiting for the same lock"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select \n\tb.*, \n\tw.pid as blocked_pid, \n\tw.txn_owner as blocked_owner, \n\tDATEDIFF(minutes, b.txn_start, getdate()) as blocked_for_mints\nfrom SVV_TRANSACTIONS b inner join SVV_TRANSACTIONS w \n\t\ton b.txn_db = w.txn_db and b.relation = w.relation\nwhere b.granted='t' and w.granted = 'f' \n\tand DATEDIFF(minutes, b.txn_start, getdate()) > 5\norder by txn_start, b.pid;\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"granted = t"}),"  means lock has been granted"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"granted = f"}),"  means lock is pending"]}),"\n",(0,a.jsx)(n.h3,{id:"deadlocked",children:"DeadLocked"}),"\n",(0,a.jsxs)(n.p,{children:["Redshift documentation recommends using ",(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"http://docs.aws.amazon.com/redshift/latest/dg/r_STV_LOCKS.html",children:"STV_LOCKS"})})," table to identify locks, this table works well until you hit a real deadlock, ",(0,a.jsx)(n.a,{href:"https://wiki.postgresql.org/wiki/Lock_Monitoring",children:"PG_LOCKS"})," could be the real life saving table that should be looked into."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select \n  current_time, \n  c.relname, \n  l.database, \n  l.transaction, \n  l.pid, \n  a.usename, \n  l.mode, \n  l.granted\nfrom pg_locks l \njoin pg_catalog.pg_class c ON c.oid = l.relation\njoin pg_catalog.pg_stat_activity a ON a.procpid = l.pid\nwhere l.pid <> pg_backend_pid();\n"})}),"\n",(0,a.jsx)(n.h2,{id:"how-to-cancel-a-query",children:"How to cancel a query?"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.code,{children:"cancel"})," can be used to Kill a query with the query pid and an optional message which will be returned to the issuer of the query and logged. PG_CANCEL_BACKEND is functionally equivalent to the CANCEL command."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"cancel <pid> 'Long-running query';\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select pg_cancel_backend(<pid>);\n"})}),"\n",(0,a.jsx)(n.p,{children:"If the query that you canceled is associated with a transaction, use the ABORT or ROLLBACK. command to cancel the transaction and discard any changes made to the data:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"abort;\n"})}),"\n",(0,a.jsx)(n.p,{children:"PG_TERMINATE_BACKEND can be used to Terminates a session."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select pg_terminate_backend(<pid>);\n"})}),"\n",(0,a.jsx)(n.p,{children:"Unless you are signed on as a superuser, you can cancel only your own queries/session. A superuser can cancel all queries/session."}),"\n",(0,a.jsx)(n.h2,{id:"bonus",children:"Bonus"}),"\n",(0,a.jsx)(n.p,{children:"Some more Tables to for more informations"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/redshift/latest/dg/r_SVL_QLOG.html",children:"SVL_QLOG"})})," - Redshift also stores the past few days of queries in ",(0,a.jsx)(n.code,{children:"svl_qlog"})," if you need to go back further"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:'select userid, query, pid, starttime, endtime, elapsed, left("substring", 50) as text from svl_qlog limit 10;\n'})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/redshift/latest/dg/r_STL_QUERYTEXT.html",children:"STL_QUERYTEXT"})}),"  All of the above tables only store the first 200 characters of each query. The full query is stored in chunks in ",(0,a.jsx)(n.code,{children:"stl_querytext"}),". Join this table in by ",(0,a.jsx)(n.code,{children:"query"}),", and sort by ",(0,a.jsx)(n.code,{children:"query_id"})," and ",(0,a.jsx)(n.code,{children:"sequence"})," to get each 200 character chunk in order"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:'select query, starttime, text, "sequence" \nfrom stl_query join stl_querytext using (query) \norder by query,sequence \nlimit 5;\n'})}),"\n",(0,a.jsx)(n.p,{children:"List of queries currently in-flight with user details"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-sql",children:"select \n\ta.userid, \n\tcast(u.usename as varchar(100)), \n\ta.query, \n\ta.label, \n\ta.pid, \n\ta.starttime, \n\tDATEDIFF(minutes, a.starttime, getdate()) as delay_in_mints, \n\tb.query as querytext\nfrom stv_inflight a, stv_recents b, pg_user u\nwhere a.pid = b.pid and a.userid = u.usesysid;\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var s=t(6540);const a={},i=s.createContext(a);function r(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}},8610:e=>{e.exports=JSON.parse('{"permalink":"/blog/troubleshooting-in-redshift","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2019-04-15-troubleshooting-in-redshift.md","source":"@site/blog/2019-04-15-troubleshooting-in-redshift.md","title":"Troubleshooting in Redshift","description":"Redshift is a one of the most popular data warehousing solution, thousands of companies running millions of ETL jobs everyday. The problem with MPP systems is troubleshooting why the jobs are hung, which are the queries blocking others.","date":"2019-04-15T00:00:00.000Z","tags":[{"inline":false,"label":"Big Data","permalink":"/blog/tags/big-data","description":"Big data technologies and concepts"},{"inline":false,"label":"Amazon Redshift","permalink":"/blog/tags/redshift","description":"Amazon Redshift data warehouse"},{"inline":false,"label":"AWS","permalink":"/blog/tags/aws","description":"Amazon Web Services"},{"inline":false,"label":"Database","permalink":"/blog/tags/database","description":"Database design and management"}],"readingTime":4.69,"hasTruncateMarker":false,"authors":[{"name":"Narendra Dubey","title":"Builder of Data Systems and Software","url":"https://im-naren.github.io/about/","page":{"permalink":"/blog/authors/narendra"},"socials":{"github":"https://github.com/im-naren","linkedin":"https://www.linkedin.com/in/im-naren/","email":"mailto:naren.dubey@zoho.com"},"imageURL":"https://github.com/im-naren.png","key":"narendra"}],"frontMatter":{"slug":"troubleshooting-in-redshift","title":"Troubleshooting in Redshift","authors":["narendra"],"tags":["big-data","redshift","aws","database"],"date":"2019-04-15T00:00:00.000Z"},"unlisted":false,"prevItem":{"title":"Speculative Execution in Hadoop","permalink":"/blog/speculative-execution-in-hadoop"},"nextItem":{"title":"Spell-correct in Python - Part 1","permalink":"/blog/spell-correct-in-python-part-1"}}')}}]);